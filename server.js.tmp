const express = require('express');
const fs = require('fs');
const { exec } = require('child_process');
const app = express();

app.use(express.json());

const BRIDGE_API_KEY = process.env.BRIDGE_API_KEY;
if (!BRIDGE_API_KEY) {
    console.error('CRITICAL: BRIDGE_API_KEY environment variable is not set!');
    process.exit(1);
}

const logFile = '/home/ubuntu/bridge/bridge.log';
function log(msg) {
    const entry = '[' + new Date().toISOString() + '] ' + msg + '\n';
    console.log(entry);
    fs.appendFileSync(logFile, entry);
}

const auth = (req, res, next) => {
    const key = req.headers['x-bridge-api-key'];
    if (key !== BRIDGE_API_KEY) return res.status(401).json({ error: 'Unauthorized' });
    next();
};

app.get('/', (req, res) => res.send('Bridge is alive'));

app.post('/spawn-ao', auth, (req, res) => {
    const { project, task } = req.body;
    log('Spawn request: ' + project);

    if (!project) return res.status(400).json({ error: 'Project required' });

    const scriptPath = '/home/ubuntu/bridge/spawn.sh';
    const command = `${scriptPath} "${project}" "${task.replace(/"/g, '\\"')}"`;

    log('Executing: ' + command);

    exec(command, (error, stdout, stderr) => {
        if (error) log('Error: ' + error);
        if (stdout) log('Out: ' + stdout);
        if (stderr) log('Err: ' + stderr);
    });

    res.json({
        success: true,
        message: 'Smoke test received. Spawning agent...',
        dashboardUrl: 'http://18.222.178.24:3000'
    });
});

app.listen(3001, '0.0.0.0', () => log('Bridge on 3001'));
