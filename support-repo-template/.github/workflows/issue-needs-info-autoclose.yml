name: Auto-close Needs-Info Issues

on:
  schedule:
    - cron: "17 4 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  close-stale-needs-info:
    runs-on: ubuntu-latest
    env:
      NEEDS_INFO_CLOSE_DAYS: "5"
    steps:
      - name: Close stale needs-info tickets
        uses: actions/github-script@v7
        with:
          script: |
            const cutoffDays = Number(process.env.NEEDS_INFO_CLOSE_DAYS || "5");
            const cutoffMs = cutoffDays * 24 * 60 * 60 * 1000;
            const now = Date.now();

            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "needs-info",
              per_page: 100,
            });

            for (const issue of issues) {
              if (issue.pull_request) continue;
              const updatedAt = new Date(issue.updated_at).getTime();
              if (!Number.isFinite(updatedAt)) continue;
              if (now - updatedAt < cutoffMs) continue;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body:
                  "Closing due to missing required diagnostics after the response window. " +
                  "Open a new ticket with complete details if the issue still exists.",
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: "closed",
                state_reason: "not_planned",
              });
            }
